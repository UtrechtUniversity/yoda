---
# copyright Utrecht University

- name: Checkout Yoda portal
  git:
    repo: "https://github.com/UtrechtUniversity/yoda-portal.git"
    dest: "/var/www/yoda"
    version: "{{ yoda_portal_version }}"
    force: "yes"
  register: portalchanges


- name: Ensure Yoda portal virtualenv exists
  shell: python3 -m virtualenv "/var/www/yoda/venv"
  args:
    creates: /var/www/yoda/venv


- name: Ensure Yoda portal dependencies are installed
  pip:
    name:
      - Flask
      - Flask-WTF
      - mod-wsgi
      - python-irodsclient==0.8.5
    virtualenv: '/var/www/yoda/venv'
    virtualenv_python: python3.6
  notify: Restart Apache webserver


- name: Install mod-wsgi
  become_user: "root"
  become: yes
  shell: |
    source /var/www/yoda/venv/bin/activate
    mod_wsgi-express install-module > /etc/httpd/conf.modules.d/02-wsgi.conf
    exit
  args:
    creates: /etc/httpd/conf.modules.d/02-wsgi.conf


- name: Copy Yoda Portal virtual host config for Apache
  template:
    src: "yoda-portal-vhost.conf.j2"
    dest: "/etc/httpd/conf.d/yoda-portal-vhost.conf"
    mode: '0644'
  notify: Restart Apache webserver


# - include_tasks: setup-nodejs-development-environment.yml
#   when: yoda_environment == "development"
