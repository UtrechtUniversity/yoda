---
# copyright Utrecht University

- name: Ensure Yoda test groups exists
  become_user: '{{ irods_service_account }}'
  become: true
  yoda_addgroup:
    groupName: '{{ item.groupName }}'
    category: '{{ item.category }}'
    subcategory: '{{ item.subcategory }}'
    schema_id: '{{ item.schema_id | default("") }}'
    retention_period: '{{ item.retention_period | default("") }}'
    description: 'Auto-generated by Ansible'
    dataClassification: '{{ item.dataClassification }}'
  with_items: '{{ test_groups }}'


- name: Ensure Yoda users are added to groups
  become_user: '{{ irods_service_account }}'
  become: true
  yoda_addgroupuser:
    groupName: '{{ item.groupName }}'
    user: '{{ item.user }}'
    role: '{{ item.role }}'
  with_items: '{{ test_group_users }}'
  when: yoda_environment == "development"


- name: Ensure Yoda users are added to groups
  become_user: '{{ irods_service_account }}'
  become: true
  yoda_addgroupuser:
    groupName: '{{ item.groupName }}'
    user: '{{ item.user }}'
    role: '{{ item.role }}'
  with_items: '{{ test_group_eus_users }}'
  when: yoda_environment == "development" or yoda_environment == "testing"


- name: Ensure Yoda intake datamanager has read access to grp-vault-initial folder
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    ichmod -M read grp-datamanager-initial /{{ irods_zone }}/home/grp-vault-initial
  ignore_errors: true


- name: Ensure Yoda intake datamanager has read access to grp-vault-test folder
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    ichmod -M read grp-datamanager-test /{{ irods_zone }}/home/grp-vault-test
  ignore_errors: true


- name: Ensure Yoda intake datamanager has read access to grp-vault-test2 folder
  become_user: '{{ irods_service_account }}'
  become: yes
  command:
    ichmod -M read grp-datamanager-test2 /{{ irods_zone }}/home/grp-vault-foo
  ignore_errors: true

- name: Ensure Yoda test data directory research-initial/testdata is present in Yoda
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    imkdir /{{ irods_zone }}/home/research-initial/testdata
  ignore_errors: true


- name: Ensure Yoda test data directory is present
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.file:
    path: '~/testdata/'
    state: directory
    mode: 0755


- name: Ensure Yoda test data directory research-default-1/transformation is present in Yoda
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    imkdir /{{ irods_zone }}/home/research-default-1/transformation
  ignore_errors: true


- name: Ensure Yoda test files are present in VM
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.copy:
    src: '{{ item }}'
    dest: '~/testdata/{{ item }}'
    mode: 0644
  with_items:
    - 'lorem.txt'
    - 'SIPI_Jelly_Beans_4.1.07.tiff'
    - 'yoda-metadata.json'


- name: Ensure Yoda test files are present in Yoda directory research-initial/testdata
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    iput -f ~/testdata/{{ item }} /{{ irods_zone }}/home/research-initial/testdata
  with_items:
    - 'lorem.txt'
    - 'SIPI_Jelly_Beans_4.1.07.tiff'


- name: Ensure Yoda INTAKE test datasets are present in VM
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.copy:
    src: '{{ item }}'
    dest: '~/testdata/{{ item }}'
    mode: 0644
  with_items:
    - 'intake_testset_initial'


- name: Ensure Yoda INTAKE test datasets are present in Yoda directory grp-intake-initial
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    iput -f -r ~/testdata/{{ item }} /{{ irods_zone }}/home/grp-intake-initial
  with_items:
    - 'intake_testset_initial'


- name: Ensure Yoda metadata is present for geo publication test
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    iput -f ~/testdata/{{ item }} /{{ irods_zone }}/home/research-teclab-0
  with_items:
    - 'yoda-metadata.json'


- name: Ensure Yoda licenses directory is present
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    imkdir /{{ irods_zone }}/yoda/licenses
  ignore_errors: true


- name: Ensure licenses are present in Yoda
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    iput -f '/etc/irods/yoda-ruleset/licenses/{{ item }}' '/{{ irods_zone }}/yoda/licenses/{{ item }}'
  with_items:
    - "Creative Commons Attribution 4.0 International Public License.txt"
    - "Creative Commons Attribution 4.0 International Public License.uri"
    - "Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International Public License.txt"
    - "Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International Public License.uri"
    - "Creative Commons Attribution-ShareAlike 4.0 International Public License.txt"
    - "Creative Commons Attribution-ShareAlike 4.0 International Public License.uri"
    - "Creative Commons Zero v1.0 Universal.txt"
    - "Creative Commons Zero v1.0 Universal.uri"
    - "Open Data Commons Attribution License (ODC-By) v1.0.txt"
    - "Open Data Commons Attribution License (ODC-By) v1.0.uri"


- name: Ensure Yoda preservable file formats directory is present
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    imkdir /{{ irods_zone }}/yoda/file_formats
  ignore_errors: true


- name: Ensure preservable file formats are present in Yoda
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    iput -f '/etc/irods/yoda-ruleset/file_formats//{{ item }}' '/{{ irods_zone }}/yoda/file_formats/{{ item }}'
  with_items:
    - "DANS.json"
    - "4TU.json"


- name: Ensure Yoda templates directory is present
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    imkdir /{{ irods_zone }}/yoda/templates
  ignore_errors: true


- name: Ensure intake module rule files are present
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.copy:
    src: '{{ item }}'
    dest: '~/.irods/{{ item }}'
    mode: 0644
  with_items:
    - 'job_movetovault.r'
    - 'job_checksums.r'
    - 'job_clearintakelocks.r'


- name: Configure cronjob to make checksums of datapackages in grp-vault-*
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.cron:
    name: 'job_checksums.r'
    minute: '*/7'
    job: '/bin/irule -r irods_rule_engine_plugin-irods_rule_language-instance -F /var/lib/irods/.irods/job_checksums.r >> /var/lib/irods/log/job_checksums.log 2>&1'


- name: Run monthly storage statistics job
  become_user: '{{ irods_service_account }}'
  become: true
  ansible.builtin.command:
    irule -r irods_rule_engine_plugin-irods_rule_language-instance -F /etc/irods/yoda-ruleset/tools/monthly-storage-statistics.r
  ignore_errors: true


- name: Ensure rods user is removed from groups
  become_user: '{{ irods_service_account }}'
  become: true
  yoda_removegroupuser:
    groupName: '{{ item.groupName }}'
    user: 'rods'
  when: item.groupName not in intake_datamanager_groups
  with_items: '{{ test_groups }}'
