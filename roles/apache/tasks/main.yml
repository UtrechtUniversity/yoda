---
# copyright Utrecht University

- name: Ensure Apache webserver is installed
  ansible.builtin.package:
    name:
      - httpd
      - httpd-devel
      - mod_ssl
      - openssl
    state: present


- name: Allow public to ports for Apache in firewall
  ansible.posix.firewalld:
    port: '{{ item }}'
    permanent: true
    state: enabled
    immediate: true
  with_items:
    - 80/tcp
    - 443/tcp
  notify: Restart firewall


- name: Ensure customized httpd config is present
  ansible.builtin.template:
    src: 'httpd.conf.j2'
    dest: '/etc/httpd/conf/httpd.conf'
    mode: '0600'
  notify: Restart Apache webserver


- name: Ensure customized SSL config is present
  ansible.builtin.template:
    src: 'ssl.conf.j2'
    dest: '/etc/httpd/conf.d/ssl.conf'
    mode: '0600'
  notify: Restart Apache webserver


- name: Ensure autoindex.conf is absent
  ansible.builtin.file:
    path: '{{ item }}'
    state: absent
  notify: Restart Apache webserver
  with_items:
    - /etc/httpd/conf.d/autoindex.conf


- name: Ensure Apache mod_lua is disabled
  ansible.builtin.file:
    path: /etc/httpd/conf.modules.d/00-lua.conf
    state: absent
  notify: Restart Apache webserver


- name: Remove CGI files used by older versions of Yoda
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /cgi-bin/
    - /var/www/cgi-bin/
    - /usr/lib/cgi-bin/
    - /etc/httpd/conf.modules.d/01-cgi.conf


- name: Remove PHP configuration file used by older versions of Yoda
  ansible.builtin.file:
    path: /etc/httpd/conf.modules.d/15-php.conf
    state: absent


- name: Remove old WSGI configuration in Apache
  ansible.builtin.file:
    path: /etc/httpd/conf.modules.d/10-wsgi.conf
    state: absent
  notify: Restart Apache webserver


- name: Ensure Apache service is configured
  ansible.builtin.service:
    name: httpd
    state: started
    enabled: '{{ yoda_enable_httpd }}'
