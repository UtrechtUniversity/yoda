---
# copyright Utrecht University

- name: Ensure old iRODS packages are absent
  ansible.builtin.package:
    name:
      - irods-uu-microservices-4.2.11_0.8.2-1
      - irods-sudo-microservices-4.2.11_1.0.0-1
      - davrods-4.2.11_1.5.0-1
      - irods-runtime-4.2.11-1
      - irods-server-4.2.11-1
      - irods-database-plugin-postgres-4.2.11-1
      - irods-rule-engine-plugin-python-4.2.11.1-1
      - irods-icommands-4.2.11-1
    state: absent
  notify: Restart iRODS


- name: Download iRODS API plugin GenQuery2 package
  ansible.builtin.get_url:
    url: "{{ irods_sudo_microservices.url }}"
    dest: "{{ rpm_dest_dir }}/{{ irods_sudo_microservices.filename }}"
    checksum: "{{ irods_sudo_microservices.checksum }}"
    mode: '0644'


- name: Install iRODS API plugin GenQuery2 packages from downloaded rpm
  ansible.builtin.yum:
    name: "{{ rpm_dest_dir }}/{{ irods_sudo_microservices.filename }}"
    state: present
  when: not ansible_check_mode


- name: Ensure iRODS API plugin GenQuery2 is configured
  become_user: '{{ irods_service_account }}'
  become: true
  # noqa fqcn[action]
  irods_genquery2:
    config_path: '/etc/irods/server_config.json'
  notify: Restart iRODS
  when: not ansible_check_mode


- name: Ensure jq is installed
  ansible.builtin.yum:
    name: jq
    state: present
