---
# copyright Utrecht University

- name: Download Minio RPM
  ansible.builtin.get_url:
    url: 'https://dl.min.io/server/minio/release/linux-amd64/archive/minio-20221005145827.0.0.x86_64.rpm'
    dest: '/tmp/minio.rpm'
    checksum: 'sha256:2f15a979045aba8acf6827a39deba9178fee6e1ace2e44cc272b5113ec892e31'
    mode: 0644


- name: Install Minio from downloaded RPM
  ansible.builtin.package:
    name: '/tmp/minio.rpm'
    state: present


- name: Ensure group minio-user exists
  ansible.builtin.group:
    name: minio-user
    state: present


- name: Ensure user minio-user exists
  ansible.builtin.user:
    name: minio-user
    group: minio-user
    create_home: false


- name: Ensure yodadeployment has access to /var/www/yoda
  ansible.builtin.file:
    path: /mnt/data/minio-s3
    state: directory
    owner: minio-user
    group: minio-user


- name: Ensure minio configuration file is present
  ansible.builtin.template:
    src: minio.j2
    dest: /etc/default/minio
    owner: root
    group: root
    mode: 0644
  notify: Restart minio


- name: Ensure minio systemd service file is present
  ansible.builtin.template:
    src: minio.service.j2
    dest: /etc/systemd/system/minio.service
    owner: root
    group: root
    mode: 0644
  notify: Restart minio


- name: Flush handlers to restart minio if needed
  ansible.builtin.meta: flush_handlers


- name: Allow public access to minio web console
  firewalld:
    port: '9090/tcp'
    permanent: true
    state: enabled
    immediate: true
  notify: Restart firewall


- name: Ensure S3cmd configuration is present
  ansible.builtin.template:
    src: s3cfg.j2
    dest: /var/lib/irods/.s3cfg
    owner: irods
    group: irods
    mode: 0644


- name: Ensure S3 keypair is present
  ansible.builtin.template:
    src: s3.keypair.j2
    dest: /var/lib/irods/s3.keypair
    owner: irods
    group: irods
    mode: 0644


- name: Check S3 bucket for Yoda is present
  become_user: irods
  become: true
  ansible.builtin.shell: s3cmd ls | grep yoda  # noqa no-changed-when
  register: bucket_check
  ignore_errors: true


- name: Ensure S3 bucket for Yoda is present
  become_user: irods
  become: true
  ansible.builtin.command: s3cmd mb s3://yoda
  when: bucket_check.stdout == ""
