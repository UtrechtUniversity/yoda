<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>External User Service - Yoda</title> <link rel="shortcut icon" href="/yoda/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/yoda/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/yoda/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/yoda/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>External User Service | Yoda</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="External User Service" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="On this website you can find release notes and technical documentation on software design and administration tasks of Yoda" /> <meta property="og:description" content="On this website you can find release notes and technical documentation on software design and administration tasks of Yoda" /> <meta property="og:site_name" content="Yoda" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="External User Service" /> <script type="application/ld+json"> {"description":"On this website you can find release notes and technical documentation on software design and administration tasks of Yoda","@type":"WebPage","url":"/yoda/design/overview/external-user-service.html","headline":"External User Service","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/yoda/yoda.svg"}},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/yoda/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/yoda/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/yoda/release-notes/" class="nav-list-link">Release Notes</a><ul class="nav-list "><li class="nav-list-item "><a href="/yoda/release-notes/release-1.8.html" class="nav-list-link">v1.8</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.7.html" class="nav-list-link">v1.7</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.6.html" class="nav-list-link">v1.6</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.5.html" class="nav-list-link">v1.5</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.4.html" class="nav-list-link">v1.4</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.3.html" class="nav-list-link">v1.3</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.2.html" class="nav-list-link">v1.2</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.1.html" class="nav-list-link">v1.1</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.0.html" class="nav-list-link">v1.0</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-0.9.7.html" class="nav-list-link">v0.9.7</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/yoda/design/" class="nav-list-link">Software Design</a><ul class="nav-list "><li class="nav-list-item "><a href="/yoda/design/api/" class="nav-list-link">API</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/yoda/design/overview/" class="nav-list-link">System Overview</a><ul class="nav-list"><li class="nav-list-item "> <a href="/yoda/design/overview/research-space.html" class="nav-list-link">Research space</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/vault-space.html" class="nav-list-link">Vault space</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/group-manager.html" class="nav-list-link">Group manager</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/statistics.html" class="nav-list-link">Statistics module</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/deposit-space.html" class="nav-list-link">Deposit space</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/intake.html" class="nav-list-link">Intake module</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/data-requests.html" class="nav-list-link">Data requests module</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/authentication.html" class="nav-list-link">Authentication</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/deployment.html" class="nav-list-link">Deployment</a> </li><li class="nav-list-item active"> <a href="/yoda/design/overview/external-user-service.html" class="nav-list-link active">External User Service</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/yoda-moai.html" class="nav-list-link">Yoda MOAI service</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/yoda/design/metadata/" class="nav-list-link">Metadata</a><ul class="nav-list"><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-form-json.html" class="nav-list-link">Metadata JSON schema</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-form.html" class="nav-list-link">Metadata form</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-import-export-technical.html" class="nav-list-link">Metadata import and export</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-mappings.html" class="nav-list-link">Metadata mappings</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-schema-identifier.html" class="nav-list-link">Metadata schema identifier</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-schemas.html" class="nav-list-link">Metadata schemas</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-transformation.html" class="nav-list-link">Metadata transformations</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-vault.html" class="nav-list-link">Metadata vault</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/yoda/design/processes/" class="nav-list-link">Processes</a><ul class="nav-list"><li class="nav-list-item "> <a href="/yoda/design/processes/async-system-execution.html" class="nav-list-link">Asynchronous and Privileged Execution</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/asynchronous-processes.html" class="nav-list-link">Asynchronous processes</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/locking-mechanism.html" class="nav-list-link">Folder Locking mechanism</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/publication-process.html" class="nav-list-link">Publication Process</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/revisions.html" class="nav-list-link">Revision management</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/vault-process.html" class="nav-list-link">To vault process in research module</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/yoda/administration/" class="nav-list-link">Administration Tasks</a><ul class="nav-list "><li class="nav-list-item "><a href="/yoda/administration/configuring-yoda.html" class="nav-list-link">Configuring Yoda</a></li><li class="nav-list-item "><a href="/yoda/administration/deploying-yoda.html" class="nav-list-link">Deploying Yoda</a></li><li class="nav-list-item "><a href="/yoda/administration/hotfixing-ruleset.html" class="nav-list-link">Hotfixing ruleset</a></li><li class="nav-list-item "><a href="/yoda/administration/local-ruleset-patch.html" class="nav-list-link">Local ruleset patches</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-licenses.html" class="nav-list-link">Installing Licenses</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-terms.html" class="nav-list-link">Installing Terms & Conditions</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-preservable-file-formats.html" class="nav-list-link">Installing lists of preservable file formats</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-metadata-schemas.html" class="nav-list-link">Installing metadata schemas</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-datarequest-module.html" class="nav-list-link">Installing datarequest module</a></li><li class="nav-list-item "><a href="/yoda/administration/upgrading-metadata-schemas.html" class="nav-list-link">Upgrading metadata schemas</a></li><li class="nav-list-item "><a href="/yoda/administration/troubleshooting-publication.html" class="nav-list-link">Troubleshooting publication</a></li><li class="nav-list-item "><a href="/yoda/administration/troubleshooting-email.html" class="nav-list-link">Troubleshooting email</a></li><li class="nav-list-item "><a href="/yoda/administration/configuring-openidc.html" class="nav-list-link">Configuring OIDC</a></li><li class="nav-list-item "><a href="/yoda/administration/troubleshooting-replication-revisions.html" class="nav-list-link">Troubleshooting replication and revision creation</a></li><li class="nav-list-item "><a href="/yoda/administration/configuring-data-access-passwords.html" class="nav-list-link">Configuring Data Access Passwords</a></li><li class="nav-list-item "><a href="/yoda/administration/restore-collection.html" class="nav-list-link">Restore collection</a></li><li class="nav-list-item "><a href="/yoda/administration/setting-job-flags.html" class="nav-list-link">Setting job flags</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/yoda/development/" class="nav-list-link">Development</a><ul class="nav-list "><li class="nav-list-item "><a href="/yoda/development/setting-up-development-environment.html" class="nav-list-link">Setting up development environment</a></li><li class="nav-list-item "><a href="/yoda/development/development-tips.html" class="nav-list-link">Development tips</a></li><li class="nav-list-item "><a href="/yoda/development/wall-of-fame.html" class="nav-list-link">Wall of Fame</a></li><li class="nav-list-item "><a href="/yoda/development/yodadrive-development-environment.html" class="nav-list-link">Setting up YodaDrive development environment</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Yoda" aria-label="Search Yoda" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/UtrechtUniversity/yoda" class="site-button" > Yoda on GitHub </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/yoda/design/">Software Design</a></li> <li class="breadcrumb-nav-list-item"><a href="/yoda/design/overview/">System Overview</a></li> <li class="breadcrumb-nav-list-item"><span>External User Service</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="external-user-service"> <a href="#external-user-service" class="anchor-heading" aria-labelledby="external-user-service"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> External User Service </h1> <h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>This technical design document describes an approach to implementing support for enrolling, removing, authenticating, and changing &amp; resetting the password of external users in Yoda.</p> <h2 id="definitions"> <a href="#definitions" class="anchor-heading" aria-labelledby="definitions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Definitions </h2> <ul> <li> <p><strong>Internal user</strong> An internal user is either a user within the UU organisation or an administrative user such as <code class="language-plaintext highlighter-rouge">rods</code>.</p> </li> <li> <p><strong>External user</strong> An external user is a user that is not part of the UU organisation. External users must have an e-mail address as their username, that does <strong>not</strong> end in either <code class="language-plaintext highlighter-rouge">@uu.nl</code> or <code class="language-plaintext highlighter-rouge">.uu.nl</code>. Any username that is an e-mail address and does <strong>not</strong> match above pattern belongs to an external user.</p> </li> </ul> <h2 id="functional-description"> <a href="#functional-description" class="anchor-heading" aria-labelledby="functional-description"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Functional description </h2> <p>The supported workflows are as follows:</p> <h3 id="enrolling-an-external-user"> <a href="#enrolling-an-external-user" class="anchor-heading" aria-labelledby="enrolling-an-external-user"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enrolling an external user </h3> <p>A group manager must be able to enroll an external user.</p> <p>When a group manager adds a new external user to a group, an invite must be sent to the e-mail address belonging to the new user. The invite must contain a generated unique URL that links to a page allowing the user to create a password and activate their account.</p> <p>The link must be invalidated either after activation, or if the external user does not create a password within 5 days.</p> <h3 id="authenticating-an-external-user"> <a href="#authenticating-an-external-user" class="anchor-heading" aria-labelledby="authenticating-an-external-user"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Authenticating an external user </h3> <p>An external user must be able to authenticate themselves via any available iRODS interface that offers PAM login.</p> <h3 id="resetting-or-changing-the-password-of-an-external-user"> <a href="#resetting-or-changing-the-password-of-an-external-user" class="anchor-heading" aria-labelledby="resetting-or-changing-the-password-of-an-external-user"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Resetting or changing the password of an external user </h3> <p>An external user must be able to reset their password. When a user submits their e-mail address to the external user service, they will receive a password reset link. Password restrictions based on information security guidelines are applied.</p> <h3 id="removing-external-users"> <a href="#removing-external-users" class="anchor-heading" aria-labelledby="removing-external-users"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Removing external users </h3> <p>An Yoda admin can remove an external user. After user deletion the external user service is notified and deletes the user.</p> <h2 id="general-architecture"> <a href="#general-architecture" class="anchor-heading" aria-labelledby="general-architecture"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> General architecture </h2> <h3 id="component-view"> <a href="#component-view" class="anchor-heading" aria-labelledby="component-view"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Component view </h3> <p><img src="/yoda/design/overview/img/eus/overview.png" alt="Component view" /></p> <h2 id="components"> <a href="#components" class="anchor-heading" aria-labelledby="components"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Components </h2> <h3 id="external-user-database"> <a href="#external-user-database" class="anchor-heading" aria-labelledby="external-user-database"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> External user database </h3> <p>The external user database must store the username, password, creator and creator zone of external users. Additionally, a hash can be stored to allow for either account activation or password reset.</p> <p>When an external user is no longer linked to user_zones the user can be deleted from the users table as well. This could be a fully automated process later.</p> <p>The external user database contains the following tables:</p> <p><strong>users:</strong></p> <div class="table-wrapper"><table> <thead> <tr> <th>Col. name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">id</code></td> <td>SERIAL</td> <td>Numerical (autoincremented) ID used for internal purposes</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">username</code></td> <td>VARCHAR(64) NOT NULL</td> <td>The e-mail address of the external user case-insensitive)</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">password</code></td> <td>CHAR(60) NULL</td> <td>A hashed password (<code class="language-plaintext highlighter-rouge">NULL</code> indicates non-activated account)</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">hash</code></td> <td>CHAR(64) NULL</td> <td>A unique hash, used for activation and password reset</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">hash_time</code></td> <td>TIMESTAMP NULL</td> <td>The creation time of the hash, used to invalidate hashes</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">creator_time</code></td> <td>TIMESTAMP NOT NULL</td> <td>The creation time of the user</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">creator_user</code></td> <td>VARCHAR(255) NOT NULL</td> <td>The username of the group manager that had this external user ‘created’</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">creator_zone</code></td> <td>VARCHAR(255) NOT NULL</td> <td>The zone the groupmananger is inviting the user from</td> </tr> </tbody> </table></div> <div class="table-wrapper"><table> <thead> <tr> <th>Index</th> <th>Type</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">id</code></td> <td>PRIMARY</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">username</code></td> <td>UNIQUE</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">hash</code></td> <td>UNIQUE</td> </tr> </tbody> </table></div> <p>The 64-char username limit is prescribed by the iCAT (<code class="language-plaintext highlighter-rouge">DB_USERNAME_LEN</code>).</p> <p><strong>user_zones:</strong></p> <div class="table-wrapper"><table> <thead> <tr> <th>Col. name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">user_id</code></td> <td>INTEGER</td> <td>ID of the user involved</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">inviter_user</code></td> <td>VARCHAR(255) NOT NULL</td> <td>The groupmanager that invited the external user</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">inviter_zone</code></td> <td>VARCHAR(255) NOT NULL</td> <td>The zone the groupmanager invited the external user from</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">inviter_time</code></td> <td>TIMESTAMP NOT NULL</td> <td>The invitation time of the user</td> </tr> </tbody> </table></div> <div class="table-wrapper"><table> <thead> <tr> <th>Index</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>(user_id, inviter_zone)</td> <td>PRIMARY</td> <td>A user can only be added to a certain zone once.</td> </tr> </tbody> </table></div> <h2 id="yoda-portal"> <a href="#yoda-portal" class="anchor-heading" aria-labelledby="yoda-portal"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Yoda portal </h2> <p>The Yoda portal login page shows a “Forgot / change password” button. On click, the “Forgot password” page on the external user service for external users is displayed. When entering an internal email the internal user should be pointed to the correct location.</p> <h3 id="group-manager"> <a href="#group-manager" class="anchor-heading" aria-labelledby="group-manager"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Group manager </h3> <p>The Group manager portal module does not need to be changed to allow for external user creation. It currently allows creation of users with an e-mail address as their username.</p> <h2 id="yoda-irods-service"> <a href="#yoda-irods-service" class="anchor-heading" aria-labelledby="yoda-irods-service"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Yoda iRODS service </h2> <h3 id="authentication"> <a href="#authentication" class="anchor-heading" aria-labelledby="authentication"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Authentication </h3> <p>External users will authenticate to iRODS using PAM. A PAM rule must be added (after <code class="language-plaintext highlighter-rouge">pam_unix</code> and <code class="language-plaintext highlighter-rouge">pam_radius_auth</code>) that will authenticate against the external user database.</p> <p>The PAM <code class="language-plaintext highlighter-rouge">succeed_if</code> module must be used in combination with “skip” actions to select the right authentication module based on a username glob. This will speed up authentication significantly.</p> <p>There is a <a href="https://github.com/pam-pgsql/pam-pgsql/">PAM-pgsql module</a> that would allow PAM to check credentials directly against the database, however, it has some drawbacks:</p> <ul> <li>This module does not exist in CentOS7 repos. We would need to compile it from source (and audit it).</li> <li>The module does not seem to support a safe password hashing algorithm (only MD5, SHA1, clear, or a DB function (which would require a separate PostgreSQL package to support anything other than MD5))</li> </ul> <p>Instead, the <code class="language-plaintext highlighter-rouge">pam_exec</code> module will be used together with <code class="language-plaintext highlighter-rouge">curl</code> to deliver a Basic-authed HTTPS POST request to the external user service, which will indicate success using the appropriate HTTP status code combined with an indicative response body text.</p> <p>This allows the external user database to be closed to outside connections, as the external user service is the only service that needs to access the database directly.</p> <p>The iRODS server will need a secret number (API key) to authenticate itself to the external service. This number must be stored as a local file on the server (not within iRODS), in a way that makes it accessible both to the PAM module and a Python Group manager rule.</p> <p>Addition: The external user service keeps track of the zones an external user is invited to. When authenticating, if a user is not registered within the eus for a zone, the user will not be able to log in to the corresponding Yoda instance.</p> <h3 id="group-and-user-management"> <a href="#group-and-user-management" class="anchor-heading" aria-labelledby="group-and-user-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Group and user management </h3> <p>The Group manager rules will need to be able to instruct the external user service to create and remove external user accounts. These requests must be authenticated with an API key, which must be available to the iRODS service account, but not accessible to user-submitted rules.</p> <p>A Python rule is used to fetch the secret from a local file and make requests to the external user service. Since Python rules can be called from anywhere in iRODS, the rule itself will need to perform authorization checks, using existing Group manager policy check functions <code class="language-plaintext highlighter-rouge">uuGroupPolicyCanGroupUserAdd</code> and <code class="language-plaintext highlighter-rouge">uuGroupPolicyCanGroupUserRemove</code>.</p> <p>External users are removed when they are removed from the last Yoda instance. A periodic cleanup job may be implemented to automate external user removal.</p> <h2 id="external-user-service-1"> <a href="#external-user-service-1" class="anchor-heading" aria-labelledby="external-user-service-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> External user service </h2> <p>The external user service is a HTTPS server that services requests to a user management API, used by iRODS; and provides an interface for external users to activate their account, and change or reset their password.</p> <p>The iRODS server, which is the client to the API provided by this service, is to be fully trusted, and is thus expected to perform all necessary authorization checks before making a request.</p> <p>The service will have exclusive access to the external user database.</p> <p>Additionally, the service must be able to send e-mails to external users and group managers. E-mails are used for invitations and password resets.</p> <h2 id="sequence-diagrams"> <a href="#sequence-diagrams" class="anchor-heading" aria-labelledby="sequence-diagrams"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sequence diagrams </h2> <h3 id="authentication-of-an-external-user"> <a href="#authentication-of-an-external-user" class="anchor-heading" aria-labelledby="authentication-of-an-external-user"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Authentication of an external user </h3> <p><img src="/yoda/design/overview/img/eus/seq-auth.png" alt="Authentication of an external user" /></p> <h3 id="enrollment-of-an-external-user-not-known-to-eus"> <a href="#enrollment-of-an-external-user-not-known-to-eus" class="anchor-heading" aria-labelledby="enrollment-of-an-external-user-not-known-to-eus"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enrollment of an external user not known to EUS </h3> <p><img src="/yoda/design/overview/img/eus/seq-enroll.png" alt="Enrollment of an external user not known to EUS" /></p> <h3 id="invitation-of-external-user-known-to-eus"> <a href="#invitation-of-external-user-known-to-eus" class="anchor-heading" aria-labelledby="invitation-of-external-user-known-to-eus"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Invitation of external user known to EUS </h3> <p><img src="/yoda/design/overview/img/eus/seq-invite.png" alt="Invitation of external user known to EUS" /></p> <h3 id="password-reset"> <a href="#password-reset" class="anchor-heading" aria-labelledby="password-reset"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Password reset </h3> <p><img src="/yoda/design/overview/img/eus/seq-pwreset.png" alt="Password reset" /></p> <h3 id="deletion-of-an-external-user"> <a href="#deletion-of-an-external-user" class="anchor-heading" aria-labelledby="deletion-of-an-external-user"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deletion of an external user </h3> <p><img src="/yoda/design/overview/img/eus/seq-delete.png" alt="Deletion of an external user" /></p> <h2 id="interfaces"> <a href="#interfaces" class="anchor-heading" aria-labelledby="interfaces"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Interfaces </h2> <h3 id="yoda-portal--irods"> <a href="#yoda-portal--irods" class="anchor-heading" aria-labelledby="yoda-portal--irods"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Yoda portal → iRODS </h3> <p>The interface between the Yoda portal and iRODS is unchanged.</p> <h3 id="irods--http-api--external-user-service"> <a href="#irods--http-api--external-user-service" class="anchor-heading" aria-labelledby="irods--http-api--external-user-service"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> iRODS → HTTP API → External user service </h3> <p>The external user service's HTTP API is used by iRODS to authenticate external users and enroll and remove external users.</p> <p>All requests from iRODS to the external user service must contain the header <code class="language-plaintext highlighter-rouge">X-Yoda-External-User-Secret</code>, containing a secret API key.</p> <p>When the secret header is not present, the external user service will respond with a 400 HTTP status code on all API requests. Additionally, API requests will be restricted to client IP addresses matching the iRODS server.</p> <p>POST parameters, if any, are supplied in the request body in JSON format, for example:</p><pre><code class="language-{.example}">{
  "username": "piet@example.com",
  "creator_user": "gm@example.com",
  "creator_zone": "tempZone"
}
</code></pre><div class="table-wrapper"><table> <thead> <tr> <th>Endpoint</th> <th>Method</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">/api/auth-check</code></td> <td>POST</td> <td>User authentication: Credentials supplied via HTTP Basic <code class="language-plaintext highlighter-rouge">Authorization</code> header.. Response: On failure: 401. On success: 200, with body text <code class="language-plaintext highlighter-rouge">Authenticated</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">/api/user/add</code></td> <td>POST</td> <td>User creation: Creates the given user in the external user database. Generates and stores an activation hash for that username. Sends an invitation e-mail to the new user. Parameters are <code class="language-plaintext highlighter-rouge">username</code>, <code class="language-plaintext highlighter-rouge">creator_user</code> and <code class="language-plaintext highlighter-rouge">creator_zone</code>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">/api/user/delete</code></td> <td>POST</td> <td>User removal: Removes the given user from the external user database. Parameters are <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">userzone</code>.</td> </tr> </tbody> </table></div> <h2 id="external-user--http-ui--external-user-service"> <a href="#external-user--http-ui--external-user-service" class="anchor-heading" aria-labelledby="external-user--http-ui--external-user-service"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> External user → HTTP UI → External user service </h2> <p>The HTTP UI is used by the external user to activate their account, and to change or reset their password.</p> <p>All POST parameters are sent in <code class="language-plaintext highlighter-rouge">x-www-form-urlencoded</code> format.</p> <p>POST actions that require the use of a hash must fail if the hash is older than the specified time:</p> <ul> <li>For account creation: 5 days</li> <li>For password reset: 15 minutes</li> </ul> <div class="table-wrapper"><table> <thead> <tr> <th>Endpoint</th> <th>Method</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">/user/:username/activate/:hash</code></td> <td>GET</td> <td>User activation page. Allows the user confirm the creation of their account.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">/user/:username/activate/:hash</code></td> <td>POST</td> <td>Confirms user activation, sets a password. Also sends an e-mail to the creator of the account. The user’s hash is cleared in the database upon use. The only parameter is <code class="language-plaintext highlighter-rouge">password</code>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">/user/forgot-password</code></td> <td>GET</td> <td>“Forgot password” page. Allows the user to request a password reset link by filling in their username</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">/user/:username/forgot-password</code></td> <td>POST</td> <td>Confirms “forgot password”. Generates a hash and sends a password reset link to the given username, if it exists. The only parameter is <code class="language-plaintext highlighter-rouge">username</code>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">/user/:username/reset-password/:hash</code></td> <td>GET</td> <td>Password reset page. Allows the user to enter a new password</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">/user/:username/reset-password/:hash</code></td> <td>POST</td> <td>Confirms password reset, sets a new password. The user’s hash is cleared in the database upon use. The only parameter is <code class="language-plaintext highlighter-rouge">password</code>.</td> </tr> </tbody> </table></div> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2017-2021 <a href="https://www.uu.nl/">Utrecht University</a>. Licensed under <a href="https://github.com/UtrechtUniversity/yoda/blob/development/LICENSE">GPLv3</a>.</p> <div class="d-flex mt-2"> <p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/UtrechtUniversity/yoda/tree/development/docs/design/overview/external-user-service.md" id="edit-this-page">Edit this page on GitHub.</a> </p> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
