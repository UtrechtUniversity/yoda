<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/yoda/assets/css/just-the-docs-default.css"> <script src="/yoda/assets/js/vendor/lunr.min.js"></script> <script src="/yoda/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/yoda/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Yoda and the iRODS Python Rule Engine Plugin | Yoda</title> <meta name="generator" content="Jekyll v3.9.3" /> <meta property="og:title" content="Yoda and the iRODS Python Rule Engine Plugin" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="On this website you can find release notes and technical documentation on software design and administration tasks of Yoda" /> <meta property="og:description" content="On this website you can find release notes and technical documentation on software design and administration tasks of Yoda" /> <meta property="og:site_name" content="Yoda" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Yoda and the iRODS Python Rule Engine Plugin" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"On this website you can find release notes and technical documentation on software design and administration tasks of Yoda","headline":"Yoda and the iRODS Python Rule Engine Plugin","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/yoda/yoda.svg"}},"url":"/yoda/design/other/python-plugin.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/yoda/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/yoda/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Release Notes category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/yoda/release-notes/" class="nav-list-link">Release Notes</a><ul class="nav-list"><li class="nav-list-item "><a href="/yoda/release-notes/release-1.9.html" class="nav-list-link">v1.9</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.8.html" class="nav-list-link">v1.8</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.7.html" class="nav-list-link">v1.7</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.6.html" class="nav-list-link">v1.6</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.5.html" class="nav-list-link">v1.5</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.4.html" class="nav-list-link">v1.4</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.3.html" class="nav-list-link">v1.3</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.2.html" class="nav-list-link">v1.2</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.1.html" class="nav-list-link">v1.1</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-1.0.html" class="nav-list-link">v1.0</a></li><li class="nav-list-item "><a href="/yoda/release-notes/release-0.9.7.html" class="nav-list-link">v0.9.7</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Software Design category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/yoda/design/" class="nav-list-link">Software Design</a><ul class="nav-list"><li class="nav-list-item "><a href="/yoda/design/api/" class="nav-list-link">API</a></li><li class="nav-list-item "><a href="#" class="nav-list-expander" aria-label="toggle links in System Overview category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/yoda/design/overview/" class="nav-list-link">System Overview</a><ul class="nav-list"><li class="nav-list-item "> <a href="/yoda/design/overview/research-space.html" class="nav-list-link">Research space</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/vault-space.html" class="nav-list-link">Vault space</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/group-manager.html" class="nav-list-link">Group manager</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/statistics.html" class="nav-list-link">Statistics module</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/deposit-space.html" class="nav-list-link">Deposit space</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/theme-packages.html" class="nav-list-link">Theme packaging</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/intake.html" class="nav-list-link">Intake module</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/data-requests.html" class="nav-list-link">Data requests module</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/authentication.html" class="nav-list-link">Authentication</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/data_package_reference.html" class="nav-list-link">Data Package Reference</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/deployment.html" class="nav-list-link">Deployment</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/external-user-service.html" class="nav-list-link">External User Service</a> </li><li class="nav-list-item "> <a href="/yoda/design/overview/yoda-moai.html" class="nav-list-link">Yoda MOAI service</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander" aria-label="toggle links in Metadata category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/yoda/design/metadata/" class="nav-list-link">Metadata</a><ul class="nav-list"><li class="nav-list-item "> <a href="/yoda/design/metadata/adr-schema-identifiers.html" class="nav-list-link">Architectural decision record schema identifier format</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-form-json.html" class="nav-list-link">Metadata JSON schema</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-form.html" class="nav-list-link">Metadata form implementation</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/schema-configuration.html" class="nav-list-link">Metadata schemas</a> </li><li class="nav-list-item "> <a href="/yoda/design/metadata/metadata-vault.html" class="nav-list-link">Metadata vault</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander" aria-label="toggle links in Processes category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/yoda/design/processes/" class="nav-list-link">Processes</a><ul class="nav-list"><li class="nav-list-item "> <a href="/yoda/design/processes/async-system-execution.html" class="nav-list-link">Asynchronous and Privileged Execution</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/asynchronous-processes.html" class="nav-list-link">Asynchronous processes</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/locking-mechanism.html" class="nav-list-link">Folder Locking mechanism</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/publication-process.html" class="nav-list-link">Publication Process</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/revisions.html" class="nav-list-link">Revision management</a> </li><li class="nav-list-item "> <a href="/yoda/design/processes/vault-process.html" class="nav-list-link">To vault process in research module</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Administration Tasks category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/yoda/administration/" class="nav-list-link">Administration Tasks</a><ul class="nav-list"><li class="nav-list-item "><a href="/yoda/administration/configuring-yoda.html" class="nav-list-link">Configuring Yoda</a></li><li class="nav-list-item "><a href="/yoda/administration/deploying-yoda.html" class="nav-list-link">Deploying Yoda</a></li><li class="nav-list-item "><a href="/yoda/administration/hotfixing-ruleset.html" class="nav-list-link">Hotfixing ruleset</a></li><li class="nav-list-item "><a href="/yoda/administration/local-ruleset-patch.html" class="nav-list-link">Local ruleset patches</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-licenses.html" class="nav-list-link">Installing Licenses</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-terms.html" class="nav-list-link">Installing Terms & Conditions</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-preservable-file-formats.html" class="nav-list-link">Installing lists of preservable file formats</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-metadata-schemas.html" class="nav-list-link">Installing metadata schemas</a></li><li class="nav-list-item "><a href="/yoda/administration/local-postfix-mta.html" class="nav-list-link">Local Postfix MTA</a></li><li class="nav-list-item "><a href="/yoda/administration/installing-datarequest-module.html" class="nav-list-link">Installing datarequest module</a></li><li class="nav-list-item "><a href="/yoda/administration/upgrading-metadata-schemas.html" class="nav-list-link">Upgrading metadata schemas</a></li><li class="nav-list-item "><a href="/yoda/administration/troubleshooting-publication.html" class="nav-list-link">Troubleshooting publication</a></li><li class="nav-list-item "><a href="/yoda/administration/using-python-irodsclient.html" class="nav-list-link">Using the python-irodsclient API</a></li><li class="nav-list-item "><a href="/yoda/administration/troubleshooting-email.html" class="nav-list-link">Troubleshooting email</a></li><li class="nav-list-item "><a href="/yoda/administration/configuring-openidc.html" class="nav-list-link">Configuring OIDC</a></li><li class="nav-list-item "><a href="/yoda/administration/troubleshooting-replication-revisions.html" class="nav-list-link">Troubleshooting replication and revision creation</a></li><li class="nav-list-item "><a href="/yoda/administration/configuring-cleanup-temporary-files.html" class="nav-list-link">Configuring cleanup functionality temporary files</a></li><li class="nav-list-item "><a href="/yoda/administration/configuring-data-access-passwords.html" class="nav-list-link">Configuring Data Access Passwords</a></li><li class="nav-list-item "><a href="/yoda/administration/restore-collection.html" class="nav-list-link">Restore collection</a></li><li class="nav-list-item "><a href="/yoda/administration/setting-job-flags.html" class="nav-list-link">Setting job flags</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Development category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/yoda/development/" class="nav-list-link">Development</a><ul class="nav-list"><li class="nav-list-item "><a href="/yoda/development/setting-up-development-environment.html" class="nav-list-link">Setting up development environment</a></li><li class="nav-list-item "><a href="/yoda/development/running-api-ui-tests.html" class="nav-list-link">Running API and UI tests</a></li><li class="nav-list-item "><a href="/yoda/development/yodadrive-development-environment.html" class="nav-list-link">Setting up YodaDrive development environment</a></li><li class="nav-list-item "><a href="/yoda/development/mock_tape_archive.html" class="nav-list-link">Mock tape archive</a></li><li class="nav-list-item "><a href="/yoda/development/development-tips.html" class="nav-list-link">Development tips</a></li><li class="nav-list-item "><a href="/yoda/development/wall-of-fame.html" class="nav-list-link">Wall of Fame</a></li></ul></li></ul> </nav> &copy; 2017-2023 <a href="https://www.uu.nl/" title="Utrecht University website">Utrecht University</a> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Yoda" aria-label="Search Yoda" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/UtrechtUniversity/yoda" class="site-button" > Yoda on GitHub </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="">Software design</a></li> <li class="breadcrumb-nav-list-item"><a href="">Other</a></li> <li class="breadcrumb-nav-list-item"><span>Yoda and the iRODS Python Rule Engine Plugin</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="yoda-and-the-irods-python-rule-engine-plugin"> <a href="#yoda-and-the-irods-python-rule-engine-plugin" class="anchor-heading" aria-labelledby="yoda-and-the-irods-python-rule-engine-plugin"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Yoda and the iRODS Python Rule Engine Plugin </h1> <p>iRODS can be used with various rule engine plugins, so that rules can be written in multiple programming languages. Yoda uses both the builtin (legacy) iRODS rule language plugin and the Python Rule Engine Plugin (PREP).</p> <p>This page contains basic information about working with the PREP in combination with Yoda. The <a href="https://github.com/irods/irods_rule_engine_plugin_python">PREP documentation</a> has additional generic information and examples.</p> <h2 id="configuring-the-python-rule-engine-plugin"> <a href="#configuring-the-python-rule-engine-plugin" class="anchor-heading" aria-labelledby="configuring-the-python-rule-engine-plugin"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuring the Python rule engine plugin </h2> <p>The Python Rule Engine Plugin is configured in <code class="language-plaintext highlighter-rouge">server_config.json</code>, in the <code class="language-plaintext highlighter-rouge">rule_engines</code> array:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"instance_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"irods_rule_engine_plugin-python-instance"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"plugin_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"irods_rule_engine_plugin-python"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"plugin_specific_configuration"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>The Python plugin is the second element in the rule engine list, after the iRODS rule language plugin, so that we can combine legacy rule language code with new Python code.</p> <h2 id="python-rule-functions"> <a href="#python-rule-functions" class="anchor-heading" aria-labelledby="python-rule-functions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Python rule functions </h2> <p>There are three different types of functions, each with its own way of handling arguments and return values:</p> <ul> <li> <p>Rules called directly by iRODS have numbered parameters passed through <code class="language-plaintext highlighter-rouge">rule_args</code>:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">acPythonPEP</span><span class="p">(</span><span class="n">rule_args</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">rei</span><span class="p">):</span>
    <span class="n">callback</span><span class="p">.</span><span class="n">writeLine</span><span class="p">(</span><span class="s">"stdout"</span><span class="p">,</span> <span class="s">"arg = "</span> <span class="o">+</span> <span class="n">rule_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div> </div> <p>Such rules can also return values through numbered output parameters.</p> </li> <li> <p>Rules called with irule or from the frontend have access to <code class="language-plaintext highlighter-rouge">global_vars</code>, in which named parameters are passed as strings including the quotes:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">rule_args</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">rei</span><span class="p">):</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">global_vars</span><span class="p">[</span><span class="s">"*arg"</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                <span class="c1"># strip the quotes
</span>    <span class="n">callback</span><span class="p">.</span><span class="n">writeLine</span><span class="p">(</span><span class="s">"stdout"</span><span class="p">,</span> <span class="s">"arg = "</span> <span class="o">+</span> <span class="n">arg</span><span class="p">)</span>
</code></pre></div> </div> <p>Output cannot be passed back through named parameters, but has to be handled with writeString/writeLine:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INPUT *arg="some argument"
OUTPUT ruleExecOut
</code></pre></div> </div> <p>Note that <code class="language-plaintext highlighter-rouge">global_vars</code> is only available to Python rule functions, not to other functions called by rule functions.</p> </li> <li> <p>Ordinary Python functions which are not called as a rule by iRODS or externally, but only by other Python code. For example:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">str1</span> <span class="o">+</span> <span class="n">str2</span>
</code></pre></div> </div> </li> </ul> <p>Explanation of parameters from the <a href="https://github.com/irods/irods_rule_engine_plugin_python#configuration">PREP documentation</a>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The first argument [...], rule_args, is a tuple containing the optional, positional parameters fed to
the rule function by its caller; these same parameters may be written to, with the effect that the
written values will be returned to the caller. The callback object is effectively a gateway through
which other rules (even those managed by other rule engine plugins) and microservices may be called.
Finally, rei (also known as "rule execution instance") is an object carrying iRODS-related context
for the current rule call, including any session variables.
</code></pre></div></div> <h2 id="running-python-rule-code-using-irule"> <a href="#running-python-rule-code-using-irule" class="anchor-heading" aria-labelledby="running-python-rule-code-using-irule"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running Python rule code using irule </h2> <p>The example below shows a simple “Hello world” rule that can be executed using <code class="language-plaintext highlighter-rouge">irule</code>. The rule takes the name argument from global_vars, strips away the quotes and prints a greeting.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def main(rule_args, callback, rei):
    name = global_vars["*name"][1:-1]
    callback.writeLine("stdout", "Hello " + name + "!")

input *name="World"
output ruleExecOut
</code></pre></div></div> <p>The code can be run by putting it in a .r file, e.g. <code class="language-plaintext highlighter-rouge">hello.r</code> and then running irule on it:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ irule -r irods_rule_engine_plugin-python-instance -F hello.r
Hello World!
</code></pre></div></div> <p>You need to have a rodsadmin account in order to run Python code this way. The rule function needs to be named <code class="language-plaintext highlighter-rouge">main</code>.</p> <h2 id="defining-python-code-in-the-ruleset"> <a href="#defining-python-code-in-the-ruleset" class="anchor-heading" aria-labelledby="defining-python-code-in-the-ruleset"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Defining Python code in the ruleset </h2> <p>iRODS Python code in the ruleset needs to ultimately be imported from <code class="language-plaintext highlighter-rouge">/etc/irods/core.py</code>. On Yoda environments, <code class="language-plaintext highlighter-rouge">core.py</code> has an import statement that imports all Python code in the Yoda ruleset directory:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from rules_uu import *
</code></pre></div></div> <p>Yoda Python rule code is put in ruleset directory <code class="language-plaintext highlighter-rouge">/etc/irods/yoda-ruleset</code>, which is linked from <code class="language-plaintext highlighter-rouge">/etc/irods/rules_uu</code>. Each rule is defined in a function.</p> <p>This is a minimal example of a rule definition in Python:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">rule_args</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">rei</span><span class="p">):</span>
    <span class="n">callback</span><span class="p">.</span><span class="n">writeLine</span><span class="p">(</span><span class="s">"stdout"</span><span class="p">,</span> <span class="s">"Hello world!"</span><span class="p">)</span>
</code></pre></div></div> <p>If you add this function to a Python file in the ruleset directory, and ensure it is included in the file’s <code class="language-plaintext highlighter-rouge">__all__</code> list (assuming it has one), you can call it using irule:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ irule -r irods_rule_engine_plugin-python-instance hello_world null ruleExecOut
Hello world!
</code></pre></div></div> <p>If the rule would have had a parameter, you could have passed it like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>irule -r irods_rule_engine_plugin-python-instance hello_world '*arg="some argument"' ruleExecOut
</code></pre></div></div> <h2 id="using-yoda-rule-decorators"> <a href="#using-yoda-rule-decorators" class="anchor-heading" aria-labelledby="using-yoda-rule-decorators"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Yoda rule decorators </h2> <p>In Yoda, the <code class="language-plaintext highlighter-rouge">rule.make</code> decorator is commonly used to write rules in a more pythonic way and to reduce boilerplate.</p> <p>This example defines a rule with two input parameters and a single output parameter using <code class="language-plaintext highlighter-rouge">rule.make</code>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@rule.make(inputs=[0,1], outputs=[2])
def foo(ctx, x, y):
    return int(x) + int(y)
</code></pre></div></div> <p>This is the equivalent of the code above without the decorator:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def foo(rule_args, callback, rei):
    x, y = rule_args[0:2]
    rule_args[2] = int(x) + int(y)
</code></pre></div></div> <p>For a complete overview of functionality of <code class="language-plaintext highlighter-rouge">rule.make</code>, please consult <a href="https://github.com/UtrechtUniversity/yoda-ruleset/blob/development/util/rule.py">the function documentation</a></p> <p>There’s also an <code class="language-plaintext highlighter-rouge">api.make</code> decorator available that creates an API function which can receive and return data in JSON format. For additional information, please consult <a href="https://github.com/UtrechtUniversity/yoda-ruleset/blob/development/util/api.py">the function documentation</a></p> <h2 id="simple-code-example-roundtrip-irods---python---irods"> <a href="#simple-code-example-roundtrip-irods---python---irods" class="anchor-heading" aria-labelledby="simple-code-example-roundtrip-irods---python---irods"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Simple code example roundtrip iRODS -&gt; Python -&gt; iRODS </h2> <p>Essence of the example is that <strong>rule_args</strong> serves as both input and as output parameters</p> <p>iRODS rule language:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># \brief Front end rule to retrieve XSD location
#
# \param[in]  folder        Path of the folder
# \param[out] schemaLocation Location of XSD
# \param[out] status        Status of the action
# \param[out] statusInfo    Information message when action was not successful

iiFrontGetSchemaLocation(*folder, *schemaLocation, *status, *statusInfo)
{
        *status = "Success";
        *statusInfo = "";

        *schema = '';

        iiRuleGetLocation(*folder, *schema); # it is not possible to directly use *schemaLocation here
        writeLine('serverLog', 'schema: ' ++ *schema);

        *schemaLocation =  *schema; # again, does not work when passing schemaLocation directly in iiRuleGetLocation
}
</code></pre></div></div> <p>Python:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># \brief Nonsense function that returns 'enriched' text based on rule_args[0]
# rule_args serves both as input and output parameters
</span>
<span class="k">def</span> <span class="nf">iiRuleGetLocation</span><span class="p">(</span><span class="n">rule_args</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">rei</span><span class="p">):</span>
      <span class="n">rule_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">'You passed  the  folder: '</span> <span class="o">+</span> <span class="n">rule_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div> <h2 id="calling-microservices-from-python-code"> <a href="#calling-microservices-from-python-code" class="anchor-heading" aria-labelledby="calling-microservices-from-python-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Calling microservices from Python code </h2> <p>Use <code class="language-plaintext highlighter-rouge">irods_types</code> to create output parameters of the proper type, and obtain the output values from <code class="language-plaintext highlighter-rouge">ret_val["arguments"][N]</code>.</p> <p><strong>Example code:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">uuGetGroups</span><span class="p">(</span><span class="n">rule_args</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">rei</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">json</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ret_val</span> <span class="o">=</span> <span class="n">callback</span><span class="p">.</span><span class="n">msiMakeGenQuery</span><span class="p">(</span><span class="s">"USER_GROUP_NAME"</span><span class="p">,</span> <span class="s">"USER_TYPE = 'rodsgroup'"</span><span class="p">,</span> <span class="n">irods_types</span><span class="p">.</span><span class="n">GenQueryInp</span><span class="p">())</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">ret_val</span><span class="p">[</span><span class="s">"arguments"</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>        <span class="c1"># output parameter type GenQueryInp
</span>
    <span class="n">ret_val</span> <span class="o">=</span> <span class="n">callback</span><span class="p">.</span><span class="n">msiExecGenQuery</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">irods_types</span><span class="p">.</span><span class="n">GenQueryOut</span><span class="p">())</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ret_val</span><span class="p">[</span><span class="s">"arguments"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># output parameter type GenQueryOut
</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">rowCnt</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">sqlResult</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">groups</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># continue with this query
</span>        <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">continueInx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">ret_val</span> <span class="o">=</span> <span class="n">callback</span><span class="p">.</span><span class="n">msiGetMoreRows</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">callback</span><span class="p">.</span><span class="n">writeString</span><span class="p">(</span><span class="s">"stdout"</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
</code></pre></div></div> <h2 id="setting-avus-from-python"> <a href="#setting-avus-from-python" class="anchor-heading" aria-labelledby="setting-avus-from-python"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting AVUs from Python </h2> <p><strong>Example code:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">irods_types</span>

<span class="k">def</span> <span class="nf">uuMetaAdd</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">objType</span><span class="p">,</span> <span class="n">objName</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">keyValPair</span>  <span class="o">=</span> <span class="n">callback</span><span class="p">.</span><span class="n">msiString2KeyValPair</span><span class="p">(</span><span class="n">attribute</span> <span class="o">+</span> <span class="s">"="</span> <span class="o">+</span> <span class="n">value</span><span class="p">,</span> <span class="n">irods_types</span><span class="p">.</span><span class="n">KeyValPair</span><span class="p">())[</span><span class="s">'arguments'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">callback</span><span class="p">.</span><span class="n">msiAssociateKeyValuePairsToObj</span><span class="p">(</span><span class="n">keyValPair</span><span class="p">,</span> <span class="n">objName</span><span class="p">,</span> <span class="n">objType</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">addCollectionStatus</span><span class="p">(</span><span class="n">rule_args</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">rei</span><span class="p">):</span>
    <span class="n">uuMetaAdd</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s">"-C"</span><span class="p">,</span> <span class="s">"/tempZone/home/research-initial"</span><span class="p">,</span> <span class="s">"status"</span><span class="p">,</span> <span class="s">"PUBLISHED"</span><span class="p">)</span>
</code></pre></div></div> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Licensed under <a href="https://github.com/UtrechtUniversity/yoda/blob/development/LICENSE">GPLv3</a>.</p> <div class="d-flex mt-2"> <p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/UtrechtUniversity/yoda/tree/development/docs/design/other/python-plugin.md" id="edit-this-page">Edit this page on GitHub.</a> </p> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
